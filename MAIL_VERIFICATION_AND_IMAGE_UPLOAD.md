# メール認証＆画像アップロード機能 実装完了 🎉

## 📋 実装概要

プロフィールアイコンに画像アップロード機能を追加し、メールアドレス認証機能を実装しました。メール認証はアンケート参加の前提条件となります。

---

## ✅ 実装内容

### 1. プロフィール画像アップロード機能

#### UI実装（mobile.html）

**基本プロフィール編集画面に追加** (行751-789):
- **画像アップロードセクション**（緑色のグラデーションボックス）
  - 説明: 「カスタム画像をアップロード」
  - 最大5MBのファイルサイズ制限
  - 画像形式（JPEG, PNG, GIF, WebP等）
  
- **ファイル選択ボタン**
  - 「画像を選択」→ アップロード後は「画像を変更」
  - ファイル名とサイズの表示
  
- **クリアボタン**
  - アップロードした画像を削除
  - デフォルトアイコンに戻る

- **プレビュー表示**
  - 24×24の円形プレビュー
  - アップロード後は即座に画像を表示
  - FontAwesomeアイコンと画像を切り替え

#### JavaScript実装（js/mobile.js）

##### `handleProfileImageUpload(event)` (行2688-2748)
**処理フロー**:
1. ファイル選択
2. バリデーション
   - ファイルサイズ: 5MB以下
   - ファイルタイプ: 画像のみ
3. FileReaderでBase64エンコード
4. プレビュー更新
5. 隠しフィールドに保存
6. UI更新（ファイル名、サイズ表示）

**エラーハンドリング**:
- ファイルサイズ超過
- 画像以外のファイル
- 読み込みエラー

##### `clearProfileImageUpload()` (行2751-2771)
- アップロードデータをクリア
- プレビューをデフォルトに戻す
- UI要素をリセット

##### `selectProfileIcon(iconClass, buttonElement)` ★UPDATED (行2780-2802)
- アイコン選択時に画像データをクリア
- `profileImageType`を'icon'に設定
- 画像アップロード情報を非表示

##### `handleBasicProfileEdit(event)` ★UPDATED
- 画像とアイコンを判定
- `profileImageType`が'upload'の場合はBase64データを使用
- それ以外はFontAwesomeアイコンクラスを使用
- PATCH APIでprofile_imageを更新

##### `loadBasicProfileEditForm()` ★UPDATED (行3052-3091)
- `profile_image`がBase64データ（`data:`で始まる）かチェック
- 画像の場合：
  - プレビューに画像を表示
  - `profileImageType`を'upload'に設定
  - クリアボタンを表示
- アイコンの場合：
  - FontAwesomeアイコンを表示
  - 対応するボタンを選択状態に

##### ランキング表示の更新
- **`loadRankingScreen()`**: 画像またはアイコンを判定して表示
- **`loadReferralScreen()`**: 紹介ランキングでも画像対応
- **`updateUserDisplay()`**: マイページのプロフィール表示

---

### 2. メールアドレス認証機能

#### UI実装（mobile.html）

**マイページに認証メニュー追加** (行652-672):
- **「認証・セキュリティ」セクション**
  - メールアドレス認証ボタン（緑色のアイコン）
  - 電話番号認証ボタン（青色のアイコン、近日公開）
  - バッジ表示（認証済/未認証）

**メール認証画面** (行2042-2127):
1. **ヘッダー**
   - 戻るボタン（マイページへ）
   - タイトル「メールアドレス認証」
   - サブタイトル「アンケート参加に必要です」

2. **認証済み表示**（初期状態hidden）
   - 緑色のチェックマーク
   - 「認証済み」メッセージ
   - 認証済みメールアドレス表示
   - 「マイページに戻る」ボタン

3. **未認証表示**
   - 青色の説明ボックス
     - アンケート参加可能
     - クライアント直接アンケート参加可能（電話認証も必要）
     - セキュリティ向上
   
   - メール送信フォーム
     - 登録済みメールアドレス（読み取り専用）
     - 「認証コードを送信」ボタン
   
   - 認証コード入力フォーム（送信後に表示）
     - デモ環境用コード表示（緑色のボックス）
     - 認証コード入力（6桁、大文字変換）
     - 「認証する」ボタン

#### JavaScript実装（js/mobile.js）

##### `loadEmailVerificationScreen()` (行3129-3151)
- 現在のメールアドレスを表示
- 認証済みかチェック
  - 認証済み: 認証済みセクションを表示
  - 未認証: 未認証セクションを表示

##### `handleEmailVerification(event)` (行3154-3187)
**処理フロー**:
1. メールアドレスのバリデーション
2. 6桁認証コードの生成
3. localStorageに保存
   - `emailVerifyCode`: 認証コード
   - `emailVerifyEmail`: メールアドレス
   - `emailVerifyCodeExpiry`: 有効期限（15分）
4. 認証コード入力セクションを表示
5. デモ環境用にコードを画面表示
6. フォームを無効化

**エラーハンドリング**:
- メールアドレス不一致
- API通信エラー

##### `handleEmailVerificationConfirm(event)` (行3190-3255)
**処理フロー**:
1. 入力値の取得とバリデーション
2. 認証コードの検証
   - localStorageから取得
   - 有効期限チェック（15分）
   - コード一致確認
3. PATCH APIで`email_verified`を`true`に更新
4. 通知を作成
5. localStorage情報のクリア
6. フォームリセット
7. 2秒後に認証済み表示に切り替え

**エラーハンドリング**:
- 認証コードが見つからない
- 有効期限切れ
- コード不一致
- API通信エラー

##### `updateEmailVerificationBadge()` (行3258-3280)
- メール認証バッジの更新
  - 認証済み: 緑色「認証済」
  - 未認証: グレー「未認証」
- 電話番号認証バッジも同様に更新

#### イベントリスナーの追加（行1133-1138）
```javascript
// メール認証フォーム
document.getElementById('emailVerificationForm').addEventListener('submit', handleEmailVerification);

// メール認証確認フォーム
document.getElementById('emailVerificationConfirmForm').addEventListener('submit', handleEmailVerificationConfirm);
```

#### `showScreen`に初期化処理を追加（行940-942）
```javascript
} else if (screenId === 'emailVerificationScreen') {
    loadEmailVerificationScreen();
```

---

## 🔒 セキュリティ機能

### 1. 画像アップロード
- **ファイルサイズ制限**: 5MB以下
- **ファイルタイプチェック**: 画像のみ許可
- **Base64エンコード**: データベースに直接保存

### 2. メール認証
- **6桁英数字コード**: ランダム生成
- **有効期限**: 15分間
- **コード検証**: 大文字変換、完全一致
- **セッション管理**: localStorage使用

---

## 📊 データベース更新

### usersテーブル（26フィールドに拡張）
```javascript
{
  // ... 既存フィールド ...
  
  email_verified: boolean,     // メールアドレス認証済み ★NEW
  profile_image: text,          // アイコンクラスまたはBase64画像データ ★UPDATED
}
```

### surveysテーブル（22フィールドに拡張）
```javascript
{
  // ... 既存フィールド ...
  
  requires_email_verification: boolean,  // メール認証必須 ★NEW
  requires_phone_verification: boolean,  // 電話番号認証必須 ★NEW
}
```

---

## 🎨 UI/UXの特徴

### 画像アップロード
- **緑色のグラデーション**: 目立つデザイン
- **ファイル情報表示**: ファイル名とサイズ
- **プレビュー**: リアルタイムで確認
- **クリアボタン**: 簡単に削除可能

### メール認証
- **2段階フロー**: コード送信 → 認証
- **デモ環境対応**: 即座にコード表示
- **視覚的フィードバック**:
  - 青色: 説明・ヘルプ
  - 緑色: 成功・認証済み
  - グレー: 未認証
- **認証済み表示**: 大きなチェックマーク

---

## 🚀 使用方法

### プロフィール画像アップロード

1. **マイページ** → 「基本情報編集」
2. **「画像を選択」**をクリック
3. **画像ファイルを選択**（最大5MB）
4. **プレビューで確認**
5. **「変更を保存」**をクリック
6. **ランキングで確認**

### メールアドレス認証

1. **マイページ** → 「メールアドレス認証」
2. **「認証コードを送信」**をクリック
3. **表示された6桁コードをコピー**
4. **コードを入力**
5. **「認証する」**をクリック
6. **成功メッセージ確認**
7. **認証済みバッジが緑色に変わる**

---

## 🔮 アンケート参加条件（将来の拡張）

### 実装予定の機能

#### 1. 基本アンケート参加条件
```javascript
// アンケート参加前のチェック（疑似コード）
function canParticipateInSurvey(survey, user) {
    // メール認証必須の場合
    if (survey.requires_email_verification && !user.email_verified) {
        showToast('このアンケートはメールアドレス認証が必要です', 'error');
        showScreen('emailVerificationScreen');
        return false;
    }
    
    return true;
}
```

#### 2. クライアント直接アンケート参加条件
```javascript
// クライアント直接アンケート参加前のチェック（疑似コード）
function canParticipateInClientSurvey(survey, user) {
    // メール認証必須
    if (!user.email_verified) {
        showToast('クライアント直接アンケートにはメールアドレス認証が必要です', 'error');
        showScreen('emailVerificationScreen');
        return false;
    }
    
    // 電話番号認証必須
    if (survey.survey_type === 'client' && survey.requires_phone_verification && !user.phone_verified) {
        showToast('このアンケートは電話番号認証も必要です', 'error');
        showToast('電話番号認証機能は近日公開予定です', 'error');
        return false;
    }
    
    return true;
}
```

#### 3. UI表示の更新
- アンケートカードに認証バッジを表示
  - 📧 メール認証必須
  - 📱 電話番号認証必須
- 未認証の場合は参加ボタンを無効化
- 認証画面へのリンクを表示

---

## 📦 ファイル変更まとめ

### 変更されたファイル
1. **mobile.html**
   - 基本プロフィール編集画面に画像アップロード追加（40行）
   - メールアドレス認証画面追加（85行）
   - マイページに認証メニュー追加（20行）

2. **js/mobile.js**
   - 画像アップロード処理実装（120行）
   - メール認証処理実装（150行）
   - ランキング表示更新（画像対応）
   - イベントリスナー追加

3. **Database Schema**
   - `users`テーブル: `email_verified`フィールド追加
   - `surveys`テーブル: `requires_email_verification`, `requires_phone_verification`フィールド追加

4. **README.md**
   - 機能一覧更新
   - メール認証機能説明追加

---

## 📊 実装統計

| 項目 | 追加/変更量 |
|------|------------|
| HTML | 約145行 |
| JavaScript | 約270行 |
| データベースフィールド | 3個 |
| 合計 | **約415行** |

---

## 🧪 テストケース

### 画像アップロード
- ✅ 画像ファイル（5MB以下）で正常アップロード
- ✅ プレビュー即座更新
- ✅ ランキングに画像表示
- ✅ マイページに画像表示
- ✅ クリアボタンで削除
- ✅ アイコン選択で画像クリア
- ❌ 5MB超過でエラー表示
- ❌ 画像以外のファイルでエラー表示

### メール認証
- ✅ 認証コード送信
- ✅ デモ環境でコード表示
- ✅ 正しいコードで認証成功
- ✅ 認証後にバッジが緑色に変更
- ✅ 認証済み表示に切り替え
- ✅ 通知作成
- ❌ 誤ったコードでエラー表示
- ❌ 有効期限切れでエラー表示
- ❌ メールアドレス不一致でエラー表示

---

## 🎉 実装完了！

**画像アップロード機能**と**メールアドレス認証機能**が完全に実装され、ユーザーは自分の写真をプロフィールに使用でき、メール認証でアンケートに参加する準備が整いました。

**デモアカウントで試す**:
1. `demo` / `demo` でログイン
2. **画像アップロード**:
   - マイページ → 基本情報編集
   - 画像を選択 → 保存
   - ランキングで確認
3. **メール認証**:
   - マイページ → メールアドレス認証
   - コード送信 → 表示されたコード入力
   - 認証完了

---

*実装日: 2025年11月19日*
*開発者: ポイしば Development Team*
