# 📢 管理者通知システム 実装ガイド

## 🎉 実装完了！

**管理者からユーザーへの通知送信システム**が完全実装されました！

---

## ✅ 実装内容サマリー

### 📢 管理者通知送信機能
- ✅ **全ユーザー一斉通知**（お知らせ・メンテナンス等）
- ✅ **個別ユーザー通知**（特定ユーザーへの連絡）
- ✅ **条件付き通知**（ランク別・ポイント数別等）
- ✅ **予約送信**（指定日時に自動送信）
- ✅ **テンプレート機能**（よく使う通知を保存）
- ✅ **自動通知トリガー**（案件承認時等に自動送信）

---

## 📁 作成・更新したファイル

### 新規作成（2ファイル）
1. ✅ `js/admin-notification-system.js` (16KB) - 通知送信システム
2. ✅ `js/admin-notification-ui.js` (15KB) - UI制御

### データベーステーブル（2テーブル）
3. ✅ `admin_notifications` - 管理者通知履歴（18フィールド）
4. ✅ `notification_templates` - 通知テンプレート（10フィールド）

### 既存ファイル更新
5. ✅ `mobile.html` - 管理者通知画面UI追加
6. ✅ `README.md` - 新機能ドキュメント追加

---

## 🚀 使い方（管理者向け）

### 通知送信画面を開く

1. **admin/admin**でログイン
2. **マイページ** → **管理者専用** → **ユーザー通知管理**

### 通知を送信する

#### 1. 全ユーザーに送信

```
送信先: 全ユーザー
タイトル: メンテナンスのお知らせ
メッセージ: 本日23時～24時にメンテナンスを実施します。
通知タイプ: システム通知
優先度: 高
```

#### 2. 条件で絞り込んで送信

```
送信先: 条件指定
条件: rank=ゴールド
タイトル: ゴールドランク限定キャンペーン
メッセージ: ゴールド会員様だけの特別キャンペーン開催中！
```

**使用可能な条件:**
- `rank=ゴールド` - ランクで絞り込み
- `points>10000` - 10,000pt以上のユーザー
- `consecutive_login_days>=7` - 連続ログイン7日以上

#### 3. 個別ユーザーに送信

```
送信先: 個別ユーザー
ユーザーID: uuid-1234, uuid-5678
タイトル: 案件承認のお知らせ
メッセージ: 「楽天カード」案件が承認されました！
```

#### 4. 予約送信

```
予約送信: チェック
送信時刻: 2025-01-20 09:00
```

---

## 🤖 自動通知トリガー

以下のイベント発生時に自動で通知が送信されます：

### 1. 案件承認時

```javascript
await AdminNotificationSystem.notifyCaseApproved(
    userId, 
    '楽天カード', 
    15000
);
```

→ 「🎉 案件承認のお知らせ: 「楽天カード」が承認されました！15000ptを獲得しました。」

### 2. 案件却下時

```javascript
await AdminNotificationSystem.notifyCaseRejected(
    userId, 
    '楽天カード', 
    '条件未達のため'
);
```

→ 「⚠️ 案件却下のお知らせ: 「楽天カード」が却下されました。理由: 条件未達のため」

### 3. ポイント交換完了時

```javascript
await AdminNotificationSystem.notifyExchangeApproved(
    userId, 
    'Amazonギフト券', 
    10000, 
    'ABCD-1234-EFGH'
);
```

→ 「✅ ポイント交換完了: Amazonギフト券への交換（10000pt）が完了しました。交換コード: ABCD-1234-EFGH」

### 4. ランクアップ時

```javascript
await AdminNotificationSystem.notifyRankUp(
    userId, 
    'ゴールド'
);
```

→ 「🎊 ランクアップ！: おめでとうございます！ゴールドランクに昇格しました！」

### 5. お問い合わせ返信時

```javascript
await AdminNotificationSystem.notifyContactReply(
    userId, 
    '12345'
);
```

→ 「💬 お問い合わせへの返信: お問い合わせ #12345 に返信がありました。」

---

## 📝 テンプレート機能

### デフォルトテンプレート（10個）

1. **案件承認通知**
2. **案件却下通知**
3. **ポイント交換完了**
4. **ランクアップ通知**
5. **メンテナンス通知**
6. **新機能リリース**
7. **キャンペーン告知**
8. **ログインボーナス**
9. **お問い合わせ返信**
10. **実績解除**

### テンプレートを使う

1. **テンプレート**タブを開く
2. 使いたいテンプレートの**「このテンプレートを使用」**ボタンをクリック
3. 自動的に**通知送信**タブに移動し、フォームに値が入力される
4. 必要に応じて編集して送信

### 変数置換

テンプレートでは以下の変数が使用できます：

- `{username}` - ユーザー名
- `{points}` - ポイント数
- `{rank}` - ランク名
- `{case_name}` - 案件名
- `{reason}` - 理由
- `{exchange_type}` - 交換先
- `{code}` - 交換コード
- `{date}` - 日付
- `{feature_name}` - 機能名
- `{campaign_name}` - キャンペーン名
- `{end_date}` - 終了日
- `{days}` - 日数
- `{ticket_number}` - チケット番号
- `{achievement_name}` - 実績名

---

## 🎨 通知タイプとアイコン

### 通知タイプ

| タイプ | 色 | 用途 |
|--------|---|------|
| システム通知 | 青 | メンテナンス、重要なお知らせ |
| お知らせ | 紫 | 新機能、キャンペーン情報 |
| 報酬通知 | 緑 | ポイント獲得、案件承認 |
| 警告 | 黄 | アカウント注意、規約違反 |
| 達成通知 | ピンク | ランクアップ、実績解除 |

### アイコン

- 🔔 ベル (`fa-bell`)
- 📢 メガホン (`fa-bullhorn`)
- 🎁 ギフト (`fa-gift`)
- ⚠️ 警告 (`fa-exclamation-triangle`)
- ℹ️ 情報 (`fa-info-circle`)
- ⭐ スター (`fa-star`)
- 🏆 トロフィー (`fa-trophy`)

---

## 📊 送信履歴

**送信履歴**タブでは、過去の送信を確認できます：

- **ステータス**: 送信済み / 予約中 / 失敗
- **送信先タイプ**: 全ユーザー / 条件指定 / 個別送信
- **送信数**: 〇人に送信
- **既読数**: 〇人が既読
- **送信日時**: YYYY-MM-DD HH:MM

---

## 🔧 開発者向け情報

### API

#### AdminNotificationSystem.sendNotification()

```javascript
await AdminNotificationSystem.sendNotification({
    targetType: 'all',              // all / individual / conditional
    targetUserIds: [],              // 個別送信時のユーザーIDリスト
    condition: null,                // 条件文字列
    title: 'タイトル',
    message: 'メッセージ本文',
    type: 'system',                 // system / announcement / reward / warning / achievement
    icon: 'fa-bell',
    linkScreen: 'homeScreen',       // リンク先画面ID
    priority: 'normal',             // low / normal / high / urgent
    scheduledTime: null,            // 予約時刻（ミリ秒）
    adminId: 'admin-user-id'
});
```

#### AdminNotificationSystem.getHistory()

```javascript
const history = await AdminNotificationSystem.getHistory(50);
// 最新50件の送信履歴を取得
```

#### AdminNotificationSystem.saveTemplate()

```javascript
await AdminNotificationSystem.saveTemplate({
    name: 'テンプレート名',
    category: 'カテゴリー',
    title: 'タイトル',
    message: 'メッセージ（{username}等の変数使用可）',
    type: 'system',
    icon: 'fa-bell',
    variables: ['username', 'points']
});
```

---

## 🐛 トラブルシューティング

### 通知が送信されない

→ 管理者権限（admin/admin）でログインしているか確認
→ ブラウザのコンソールでエラーをチェック

### 条件指定が動作しない

→ 条件の書き方を確認：`rank=ゴールド`、`points>5000`等
→ 複数条件は`&`で連結：`rank=ゴールド&points>10000`

### 予約送信が動作しない

→ 予約時刻が未来の日時か確認
→ 1分ごとに自動チェックされるため、最大1分の遅延あり

### テンプレートが表示されない

→ デフォルトテンプレートは管理者初回ログイン時に自動作成
→ 手動で作成する場合は「新規テンプレート作成」ボタン

---

## 💡 活用例

### 例1: 週末キャンペーン告知

```
送信先: 全ユーザー
タイトル: 🎉 週末限定！ポイント2倍キャンペーン
メッセージ: 本日～日曜日まで、全案件のポイントが2倍！この機会をお見逃しなく！
通知タイプ: お知らせ
優先度: 高
リンク先: 案件一覧
```

### 例2: 高額ポイント保持者への限定案件

```
送信先: 条件指定
条件: points>50000
タイトル: 💎 VIP限定案件のご案内
メッセージ: 50,000pt以上の会員様だけの特別案件をご用意しました！
通知タイプ: お知らせ
優先度: 高
```

### 例3: 新規登録者へのウェルカムメッセージ（予約）

```
送信先: 条件指定
条件: consecutive_login_days=1
タイトル: 🎊 ようこそポイしばへ！
メッセージ: 登録ありがとうございます！まずはデイリーボーナスをチェック！
通知タイプ: お知らせ
予約送信: 毎日9:00
```

---

## ✨ まとめ

**管理者通知システム**により、以下が可能になりました：

- 🎯 **ターゲティング通知** - 条件で絞り込んで効率的に配信
- ⏰ **予約送信** - 最適なタイミングで自動送信
- 🤖 **自動化** - イベントトリガーで手動作業不要
- 📝 **テンプレート** - よく使う通知を簡単に再利用
- 📊 **分析** - 送信数・既読数で効果測定

**ユーザーエンゲージメントを大幅に向上**させる強力な機能です！🚀

---

**実装日**: 2025-01-19  
**バージョン**: 1.0.0
